#!/usr/bin/env python3
import re
import time
import json
import os
import getpass

LOG_DIR = "/data/logs"
USER_NAME = getpass.getuser()
RAW_LOG = f"{LOG_DIR}/{USER_NAME}_commands.log"
JSON_LOG = f"{LOG_DIR}/{USER_NAME}_commands.json"

PROMPT_REGEX = re.compile(r'^[^@]+@[^:]+:.*[$#] ')

def process_block(cmd, output_lines, f_json):
    if not cmd.strip():
        return
    record = {
        "timestamp": time.strftime("%Y-%m-%dT%H:%M:%S%z"),
        "user": USER_NAME,
        "cmd": cmd,
        "output": "\n".join(output_lines).strip()
    }
    f_json.write(json.dumps(record, ensure_ascii=False) + "\n")
    f_json.flush()

# 等待日志文件出现
while not os.path.exists(RAW_LOG):
    time.sleep(1)

with open(RAW_LOG, "r") as f_raw, open(JSON_LOG, "a") as f_json:
    f_raw.seek(0, os.SEEK_END)  # 从文件末尾开始读
    cmd = None
    output_lines = []

    while True:
        line = f_raw.readline()
        if not line:
            time.sleep(0.1)
            continue

        line = line.rstrip("\n")

        if PROMPT_REGEX.match(line):
            if cmd is not None:
                process_block(cmd, output_lines, f_json)
            cmd = PROMPT_REGEX.sub("", line)
            output_lines = []
        else:
            output_lines.append(line)
