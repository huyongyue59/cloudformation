record_command() {
    local USER_NAME=$(logname 2>/dev/null || whoami)
    local LOG_FILE="/data/logs/${USER_NAME}_commands.json"

    # 获取用户输入的最后一条历史命令
    local CMD=$(history 1 | sed 's/^[ ]*[0-9]*[ ]*//')
    [[ -z "$CMD" ]] && return

    local TIMESTAMP=$(date '+%Y-%m-%dT%H:%M:%S%z')

    # 执行命令并捕获输出
    local OUTPUT
    OUTPUT=$(eval "$CMD" 2>&1)
    local ESCAPED_OUTPUT
    ESCAPED_OUTPUT=$(echo "$OUTPUT" | sed ':a;N;$!ba;s/"/\\"/g; s/\n/\\n/g')

    echo "{\"timestamp\":\"$TIMESTAMP\",\"user\":\"$USER_NAME\",\"cmd\":\"$CMD\",\"output\":\"$ESCAPED_OUTPUT\"}" >> "$LOG_FILE"
}
