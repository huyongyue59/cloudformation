#!/bin/bash
LOG_DIR="/data/logs"
USER_NAME=$(logname 2>/dev/null || whoami)
LOG_FILE="$LOG_DIR/${USER_NAME}_commands.json"

# 登录 shell初始化覆盖旧日志
if [[ $- == *i* && -z "$LOG_INITIALIZED" ]]; then
    > "$LOG_FILE"
    export LOG_INITIALIZED=1
fi

# 启动 script 子 shell 记录所有输出
# -q 静默，-f 实时写入
SCRIPT_TMP=$(mktemp)
script -q -f "$SCRIPT_TMP" bash -i

# 在 trap 中把命令和输出写入 JSON
trap '{
    CMD="$BASH_COMMAND"
    [[ -z "$CMD" ]] && return
    [[ "$CMD" == "record_command" ]] && return
    OUTPUT=$(tail -n1 "$SCRIPT_TMP" 2>/dev/null | sed "s/\"/\\\\\"/g; s/$/\\n/")
    echo "{\"timestamp\":\"$(date +%Y-%m-%dT%H:%M:%S%z)\",\"user\":\"'"$USER_NAME"'\",\"cmd\":\"$CMD\",\"output\":\"$OUTPUT\"}" >> "'"$LOG_FILE"'"
}' DEBUG
