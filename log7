#!/bin/bash
# -------------------------------------------
# SSH 命令记录器 - 测试用
# -------------------------------------------

# 已存在的日志目录
LOG_DIR="/data/logs"

# 定义记录函数
record_command() {
    local USER_NAME=$(logname 2>/dev/null || whoami)
    local LOG_FILE="$LOG_DIR/${USER_NAME}_commands.json"

    # 当前命令
    local CMD="$BASH_COMMAND"
    [[ -z "$CMD" ]] && return
    [[ "$CMD" == "record_command" ]] && return
    [[ "$CMD" == "exit" ]] && return
    [[ "$CMD" == "logout" ]] && return

    # 获取命令输出
    local OUTPUT
    OUTPUT=$(eval "$CMD" 2>&1)

    # JSON 安全处理
    local ESCAPED_OUTPUT
    ESCAPED_OUTPUT=$(echo "$OUTPUT" | sed ':a;N;$!ba;s/"/\\"/g; s/\n/\\n/g')

    # 写入日志
    echo "{\"timestamp\":\"$(date '+%Y-%m-%dT%H:%M:%S%z')\",\"user\":\"$USER_NAME\",\"cmd\":\"$CMD\",\"output\":\"$ESCAPED_OUTPUT\"}" >> "$LOG_FILE"
}

# 捕获每条命令
trap record_command DEBUG

echo "Command logger active. All commands will be recorded to $LOG_DIR/<user>_commands.json"
echo "Type 'exit' to logout normally."
