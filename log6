# 日志目录
LOG_DIR="/data/logs"
mkdir -p "$LOG_DIR"

record_command() {
    local USER_NAME=$(logname 2>/dev/null || whoami)
    local LOG_FILE="$LOG_DIR/${USER_NAME}_commands.json"

    # 获取最近一条历史命令
    local CMD=$(history 1 | sed 's/^[ ]*[0-9]*[ ]*//')
    [[ -z "$CMD" ]] && return

    local TIMESTAMP=$(date '+%Y-%m-%dT%H:%M:%S%z')
    local OUTPUT=$(eval "$CMD" 2>&1)
    local ESCAPED_OUTPUT=$(echo "$OUTPUT" | sed ':a;N;$!ba;s/"/\\"/g; s/\n/\\n/g')

    echo "{\"timestamp\":\"$TIMESTAMP\",\"user\":\"$USER_NAME\",\"cmd\":\"$CMD\",\"output\":\"$ESCAPED_OUTPUT\"}" >> "$LOG_FILE"
}

export -f record_command
PROMPT_COMMAND="record_command"
