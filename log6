# 日志目录
LOG_DIR="/data/logs"
mkdir -p "$LOG_DIR"
chmod 777 "$LOG_DIR"  # 确保所有用户可写

record_command() {
    local USER_NAME=$(logname 2>/dev/null || whoami)
    local LOG_FILE="$LOG_DIR/${USER_NAME}_commands.json"

    # 当前正在执行的命令
    local CMD="$BASH_COMMAND"
    [[ -z "$CMD" ]] && return
    [[ "$CMD" == "record_command" ]] && return  # 避免记录自身

    # 捕获命令输出
    local OUTPUT
    OUTPUT=$(eval "$CMD" 2>&1)

    # JSON 安全处理
    local ESCAPED_OUTPUT
    ESCAPED_OUTPUT=$(echo "$OUTPUT" | sed ':a;N;$!ba;s/"/\\"/g; s/\n/\\n/g')

    # 写入日志
    echo "{\"timestamp\":\"$(date '+%Y-%m-%dT%H:%M:%S%z')\",\"user\":\"$USER_NAME\",\"cmd\":\"$CMD\",\"output\":\"$ESCAPED_OUTPUT\"}" >> "$LOG_FILE"
}

# 使用 DEBUG trap 捕获每条命令
trap record_command DEBUG
