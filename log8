#!/bin/bash
# -------------------------------------------
# SSH 命令记录器 - 覆盖旧日志，避免 sudo su 报错
# -------------------------------------------

LOG_DIR="/data/logs"
USER_NAME=$(logname 2>/dev/null || whoami)
LOG_FILE="$LOG_DIR/${USER_NAME}_commands.json"

# 登录 shell 初始化：覆盖旧日志
# 仅在交互式登录 shell 执行一次
if [[ $- == *i* && -z "$LOG_INITIALIZED" ]]; then
    > "$LOG_FILE"  # 覆盖旧日志
    export LOG_INITIALIZED=1
fi

record_command() {
    local CMD="$BASH_COMMAND"
    [[ -z "$CMD" ]] && return
    [[ "$CMD" == "record_command" ]] && return
    [[ "$CMD" == "exit" ]] && return
    [[ "$CMD" == "logout" ]] && return

    # 仅记录命令文本，避免 sudo su 出错
    echo "{\"timestamp\":\"$(date '+%Y-%m-%dT%H:%M:%S%z')\",\"user\":\"$USER_NAME\",\"cmd\":\"$CMD\"}" >> "$LOG_FILE"
}

trap record_command DEBUG
